{
  "id" : "ff879fbb-67d1-4099-8246-406dbeca841d",
  "name" : "Selligent -> Customer & Email Subscription Info",
  "enabled" : false,
  "tasks" : [ {
    "id" : "da6ffbbb-7b22-40ba-9d75-c0e7cd71e854",
    "ordinal" : 1,
    "taskParameters" : [ {
      "id" : "f1e20212-61b5-4177-88a4-f40b04258a73",
      "ordinal" : 1,
      "value" : "ftpuser",
      "desc" : "User to login to ftp",
      "name" : "user",
      "valueType" : 0,
      "secret" : false,
      "refId" : "4f75fa01-c582-49aa-8f20-1b48462a8b28"
    }, {
      "id" : "1e570fae-d324-408e-93c9-1a6810e966c7",
      "ordinal" : 2,
      "value" : "Cb6noRl93L3xieH1vfPSaA==",
      "desc" : "Password to login to ftp",
      "name" : "password",
      "valueType" : 0,
      "secret" : true,
      "refId" : "48fbf631-e014-45ee-a8eb-298ac7d1fa21"
    }, {
      "id" : "52f24ce1-6e71-455e-9c7f-b388b3f53c11",
      "ordinal" : 3,
      "value" : "ftps://themet.ignitiontransform.com/transform/themet/input/SelligentCustomers_.*.xml",
      "desc" : "Url to file",
      "name" : "url",
      "valueType" : 0,
      "secret" : false,
      "refId" : "45c250b3-72b5-4d81-a392-6ab7c6f5709d"
    }, {
      "id" : "25750fb7-d924-4bc3-bfa3-2b0f7a2d08ff",
      "ordinal" : 4,
      "value" : "SelligentCustomersFile",
      "desc" : "Key name of output file",
      "name" : "outputKey",
      "valueType" : 0,
      "secret" : false,
      "refId" : "201b77ea-8e35-4c3c-9f45-dd8afc123e10"
    } ],
    "job" : {
      "id" : "ff879fbb-67d1-4099-8246-406dbeca841d",
      "name" : "Selligent -> Customer & Email Subscription Info",
      "enabled" : false,
      "desc" : "",
      "status" : "READY",
      "snsARN" : "arn:aws:sns:us-east-1:194810246581:The_Met_Job_d3b6e6d8-f8a8-4c96-a9ec-3c3f50d487d0",
      "key" : "MET-00000017",
      "readOnly" : false,
      "scheduleEnabled" : false,
      "scheduleAmount" : 0,
      "scheduleSunday" : false,
      "scheduleMonday" : false,
      "scheduleTuesday" : false,
      "scheduleWednesday" : false,
      "scheduleThursday" : false,
      "scheduleFriday" : false,
      "scheduleSaturday" : false,
      "environment" : "STAGING"
    },
    "name" : "Download File to Map Task",
    "key" : "Core::DownloadFileToMapTask",
    "comment" : "",
    "clazz" : "com.ignitioncommerce.transform.tasks.core.DownloadFileToMapTask",
    "enabled" : true,
    "desc" : "Task used to download a file from FTP,SFTP,FTPS,Local and S3.",
    "refId" : "84211b05-40ce-4939-874d-825b983c3bda",
    "clazzType" : "Java",
    "childTasks" : [ ],
    "hasSubTask" : false,
    "stopOnError" : true,
    "reportOnError" : true
  }, {
    "id" : "bb3e9a1e-36b3-46cd-bd40-2cf1226435a8",
    "ordinal" : 2,
    "taskParameters" : [ {
      "id" : "90e5be43-8a34-446d-8dc0-2ab714d8c767",
      "ordinal" : 1,
      "value" : "/*\n * Reads Customer xml from Aptos and converts to Epsilon file\n *\n */\nvar inDebug = dict.inDebug; \nload('!{ThisHost}/js/global.js');\nvar root = new java.util.HashMap();\nvar allCustomers = new java.util.ArrayList();\n\nvar sdfParse = new java.text.SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss\");\nvar thisDate = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\nvar fileDate;\ntry {\n    // Get Date from file\n    var fileName = dict.get('SelligentCustomersFile_ORIG_FILE_NAME_');\n    var pos = fileName.indexOf('_');\n    var pos2 = fileName.indexOf('_', pos+1);\n    var fileDate = fileName.substring(pos+1, pos2);\n    fileDate = fileDate.substring(4,6) + '-' + fileDate.substring(6,8) + '-' + fileDate.substring(0,4);\n    // process customers.  Make sure we don't do infinity\n    for (var i=1;i<11;i++) {\n        var customers = processCustomers(i);\n        allCustomers.addAll(customers);\n        if (customers.size() < 250) break;\n    }\n    root.put('CustomersList', customers);\n    dict.put('Root', root);    \n} catch (err) {\n    var errMessage = 'An error occurred while processing Aptos Customer file: ' +\n        fileName + ' into Selligent API calls.  Exception: ' + err;\n    ICT.TASK_ERROR('Selligent -> Customer & Email Subscription Info', errMessage);    \n}\n\nfunction generateSha256Hash(str2sign) {\n    if (inDebug) {\n        print('generateSha256Hash('+str2sign+')');\n    }\n    var md = java.security.MessageDigest.getInstance('SHA-256');\n\n    md.update(str2sign.getBytes('UTF-8'));\n    var digest = md.digest();\n    var sb = new java.lang.StringBuffer();\n    for (var i=0;i<digest.length;i++) {\n        sb.append(java.lang.String.format(\"%02x\", digest[i]));\n    }\n    if (inDebug) {\n        print('generateSha256Hash return -> ' + sb.toString());\n    }\n    return sb.toString();\n}\n\nfunction processCustomers(page) {\n    var customers = new java.util.ArrayList();\n    var url = 'https://api-beta.shopvisible.com/CustomerService.asmx/GetCustomers?ClientName=TheMet_Staging'+\n        '&Guid=cd792d11-bf8c-e611-8101-06a33a6db6fd&ProcessingOptions='+encodeURIComponent('LastModifiedSince='+fileDate) +\n        '&PageNum='+page;\n    if (inDebug) {\n        print('processCustomers('+page+')');\n    }\n\n    var params = {};\n    params['Content-Type'] = 'text/xml';    \n    var xml = ICT.REST.GET(url, params);\n\n    var doc = ICT.XML.DOC(xml);\n    var xPathFactory = javax.xml.xpath.XPathFactory.newInstance();\n    var xpath = xPathFactory.newXPath();\n    var xpathExpression = xpath.compile('/Customers/Customer');\n    var nodeList = xpathExpression.evaluate(doc, javax.xml.xpath.XPathConstants.NODESET);\n    for (var i=0;i<nodeList.getLength();i++) {\n        var customerNode = nodeList.item(i);\n        var optIn = ICT.XML.TEXT(customerNode, 'CustomerPromos');\n        var selligentCustomerInfo = selligentCustomer(ICT.XML.TEXT(customerNode, 'CustomerEmail'));\n        print('optIn: ' + optIn);\n        if (optIn === 'false') {\n            \n            if (selligentCustomerInfo === null) continue;            \n        }\n        // upsert\n        upsertCustomer(selligentCustomerInfo, customerNode);\n    }\n    if (inDebug) {\n        print('processCustomers return null');\n    }\n} \n\nfunction upsertCustomer(selligentCustomerInfo, customerNode) {\n    if (inDebug) {\n        print('upsertCustomer('+selligentCustomerInfo+','+customerNode+')');\n    }\n    \n    // try our check_credentials\n    var url = 'https://app.svwps.com/api/v2/upsert_record.json';\n    var params = {\n        Accept: 'application/json',\n        'Content-Type': 'application/json'\n    };\n    var optIn = (ICT.XML.TEXT(customerNode, 'CustomerPromos') === 'true');\n    var name = ICT.XML.TEXT(customerNode, 'CustomerLastName');\n    var postal = ICT.XML.TEXT(customerNode, 'CustomerPostalCode');\n    var data = {};\n    data.metstore = optIn ? '1' : '0';\n    \n    if (!selligentCustomerInfo) {\n        data.datesub = thisDate.format(new java.util.Date());\n    } else {\n        if (selligentCustomerInfo.originalsource === '') {\n            data.originalsource = 'APTOS';\n        }\n        data.datesub = selligentCustomerInfo.data.datesub;\n    }\n    var explicit = 'N';\n    if (!name && !postal) {\n        explicit = 'Y';\n    }\n    if (optIn) {\n        data.explicit = explicit;\n    }\n    // don't know about this one\n    //data.metstoreconsentdate = thisDate.format(new java.util.Date());\n    data.metstoreconsentdate = data.datesub;\n    data.metstore_last_update = thisDate.format(new java.util.Date());\n    try {\n        var dt = sdfParse.parse(ICT.XML.TEXT(customerNode, 'CustomerModifiedDate'));\n        data.metstore_last_update = thisDate.format(dt);\n    } catch (err) {\n        print(err);\n    }\n    data.aptosid = ICT.XML.TEXT(customerNode, 'CustomerID');\n    data.lastSource = 'APTOS';\n    var tsz = ICT.XML.TEXT(customerNode, 'CustomerFirstName');\n    if (tsz) data.fname = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerLastName');\n    if (tsz) data.lname = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerCity');\n    if (tsz) data.city = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerStateProvince');\n    if (tsz) data.state = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerPostalCode');\n    if (tsz) data.zip = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerCountry');\n    if (tsz) data.country = tsz;\n    tsz = ICT.XML.TEXT(customerNode, 'CustomerDateofBirth');\n    if (tsz) data.birthdate = tsz;\n    \n    var email = ICT.XML.TEXT(customerNode, 'CustomerEmail');\n    var entry = {\n        user_id: email,\n        data: data\n    };\n    \n    var str2sign = '128d19199eadd5c5b8f053cda28f5ca29583ed4baff54630250098eb378c8f9fclientMetropolitanMuseumentry'+JSON.stringify(entry)+'organizationthemetsitePreference_Center';\n    var signature = generateSha256Hash(str2sign);\n    var payload = {\n        organization: 'themet',\n        client: 'MetropolitanMuseum',\n        site: 'Preference_Center',\n        entry: JSON.stringify(entry),\n        signature: signature\n    };    \n    print('payload: ' + JSON.stringify(payload));\n\n    var response = ICT.REST.POST(url, payload, params);\n    print(response);\n    if (inDebug) {\n        print('upsertCustomer return null');\n    }\n}\n\nfunction selligentCustomer(email) {\n    if (inDebug) {\n        print('isSelligentCustomer(' + email + ')');\n    }\n    var str2sign = '128d19199eadd5c5b8f053cda28f5ca29583ed4baff54630250098eb378c8f9fclientMetropolitanMuseumorganizationthemetsitePreference_Centeruser_id'+email;\n    var signature = generateSha256Hash(str2sign);\n    // try our check_credentials\n    var url = 'https://app.svwps.com/api/v2/retrieve_user.json?signature='+signature+'&user_id='+email+\n        '&organization=themet&client=MetropolitanMuseum&site=Preference_Center&key=128d19199eadd5c5b8f053cda28f5ca29583ed4baff54630250098eb378c8f9f';\n    print(url);\n    var response = ICT.REST.GET(url, {});\n    if (inDebug) {    \n        print(response);    \n    }\n    var retVal = null;\n    var obj = JSON.parse(response);\n    if (obj.user_id) {\n        retVal = obj;\n    } \n    if (inDebug) {\n        print('isSelligentCustomer return -> ' + retVal);\n    }\n    return retVal;\n}\n",
      "desc" : "Script to execute",
      "name" : "script",
      "valueType" : 2,
      "secret" : false,
      "refId" : "61734d1c-1ff6-4a2b-a251-00f3bd76b9ed"
    } ],
    "job" : {
      "id" : "ff879fbb-67d1-4099-8246-406dbeca841d",
      "name" : "Selligent -> Customer & Email Subscription Info",
      "enabled" : false,
      "desc" : "",
      "status" : "READY",
      "snsARN" : "arn:aws:sns:us-east-1:194810246581:The_Met_Job_d3b6e6d8-f8a8-4c96-a9ec-3c3f50d487d0",
      "key" : "MET-00000017",
      "readOnly" : false,
      "scheduleEnabled" : false,
      "scheduleAmount" : 0,
      "scheduleSunday" : false,
      "scheduleMonday" : false,
      "scheduleTuesday" : false,
      "scheduleWednesday" : false,
      "scheduleThursday" : false,
      "scheduleFriday" : false,
      "scheduleSaturday" : false,
      "environment" : "STAGING"
    },
    "name" : "Script Task",
    "key" : "Core::ScriptTask",
    "clazz" : "com.ignitioncommerce.transform.tasks.core.ScriptTask",
    "enabled" : true,
    "desc" : "Task used to execute custom javascript",
    "refId" : "f5d44f40-cbd4-45fa-b45f-b062e546ad0f",
    "clazzType" : "Java",
    "childTasks" : [ ],
    "hasSubTask" : false,
    "stopOnError" : true,
    "reportOnError" : true
  } ],
  "desc" : "",
  "status" : "READY",
  "snsARN" : "arn:aws:sns:us-east-1:194810246581:The_Met_Job_d3b6e6d8-f8a8-4c96-a9ec-3c3f50d487d0",
  "key" : "MET-00000017",
  "readOnly" : false,
  "scheduleEnabled" : false,
  "scheduleAmount" : 0,
  "scheduleSunday" : false,
  "scheduleMonday" : false,
  "scheduleTuesday" : false,
  "scheduleWednesday" : false,
  "scheduleThursday" : false,
  "scheduleFriday" : false,
  "scheduleSaturday" : false,
  "environment" : "STAGING"
}